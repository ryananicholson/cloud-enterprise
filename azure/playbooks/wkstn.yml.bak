---
- name: Configure Workstations
  hosts: wkstn
  tasks:
    - name: Configure DNS
      ansible.windows.win_dns_client:
        adapter_names: Ethernet
        dns_servers: DNSADDR
    - name: Join DOMAIN Domain
      ansible.windows.win_domain_membership:
        dns_domain_name: DOMAIN.local
        domain_admin_user: adminuser@DOMAIN.local
        domain_admin_password: P@$$w0rd1234!
        state: domain
      register: domain_state
    - name: Reboot
      ansible.windows.win_reboot:
      when: domain_state.reboot_required
    - name: Download Log Analytics Agent
      ansible.windows.win_get_url:
        url: https://go.microsoft.com/fwlink/?LinkId=828603
        dest: C:\logagent.exe
    - name: Extract Log Analytics files
      ansible.windows.win_command: logagent.exe /c /t:C:\loganalytics
    - name: Install Log Analytics agent
      ansible.windows.win_command: setup.exe /qn NOAPM=1 ADD_OPINSIGHTS_WORKSPACE=1 OPINSIGHTS_WORKSPACE_AZURE_CLOUD_TYPE=0 OPINSIGHTS_WORKSPACE_ID="WORKID" OPINSIGHTS_WORKSPACE_KEY="WORKKEY" AcceptEndUserLicenseAgreement=1
      args:
        chdir: C:\loganalytics
